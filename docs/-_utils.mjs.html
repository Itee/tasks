<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>@itee/tasks v1.1.1 Source: _utils.mjs</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.dark.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cyborg.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top ">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">@itee/tasks v1.1.1</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="global.html#checkBundlingFromEsmFilesDirectTask">checkBundlingFromEsmFilesDirectTask</a></li><li><a href="global.html#checkBundlingTask">checkBundlingTask</a></li><li><a href="global.html#computeBenchmarksTask">computeBenchmarksTask</a></li><li><a href="global.html#computeUnitTestsTask">computeUnitTestsTask</a></li><li><a href="global.html#createRollupConfigs">createRollupConfigs</a></li><li><a href="global.html#npmrunclean">npm run clean</a></li><li><a href="global.html#npmrunhelpdefault">npm run help ( default )</a></li><li><a href="global.html#npmrunlint">npm run lint</a></li><li><a href="global.html#npmrunpatch">npm run patch</a></li><li><a href="global.html#npmrunrelease">npm run release</a></li><li><a href="global.html#npmruntest">npm run test</a></li><li><a href="global.html#runBenchmarksForBackendTask">runBenchmarksForBackendTask</a></li><li><a href="global.html#runBenchmarksForFrontendTask">runBenchmarksForFrontendTask</a></li><li><a href="global.html#runUnitTestsForBackendTask">runUnitTestsForBackendTask</a></li><li><a href="global.html#runUnitTestsForFrontendTask">runUnitTestsForFrontendTask</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: _utils.mjs</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">import commonjs          from '@rollup/plugin-commonjs'
import nodeResolve       from '@rollup/plugin-node-resolve'
import terser            from '@rollup/plugin-terser'
import colors            from 'ansi-colors'
import childProcess      from 'child_process'
import log               from 'fancy-log'
import figlet            from 'figlet'
import { glob }          from 'glob'
import {
    parallel,
    series
}                        from 'gulp'
import {
    existsSync,
    mkdirSync,
    readFileSync,
    writeFileSync
}                        from 'node:fs'
import {
    basename,
    dirname,
    extname,
    join,
    normalize,
    relative,
}                        from 'node:path'
import { fileURLToPath } from 'node:url'
import replace           from 'rollup-plugin-re'

const {
          red,
          green,
          yellow,
          blue,
          magenta,
          cyan
      } = colors

/// Debugging

const isDebugging = ( process.env.RUNNER_DEBUG &amp;&amp; process.env.RUNNER_DEBUG === '1' )

/// Package paths and data

function _getPackageRootDirectory() {

    let __dirname

    if ( import.meta.dirname ) {
        __dirname = import.meta.dirname
    } else if ( import.meta.filename ) {
        __dirname = dirname( import.meta.filename )
    } else if ( import.meta.url ) {
        const __filename = fileURLToPath( import.meta.url )
        __dirname        = dirname( __filename )
    } else {
        throw new Error( 'Unable to retrieve module dirname.' )
    }

    return join( __dirname, '..' )

}

const iteePackageRootDirectory           = _getPackageRootDirectory()
const iteePackageJsonPath                = join( iteePackageRootDirectory, 'package.json' )
const iteePackageConfigurationsDirectory = join( iteePackageRootDirectory, 'configs' )
const iteePackageNodeModulesDirectory    = join( iteePackageRootDirectory, 'node_modules' )
const iteePackageSourcesDirectory        = join( iteePackageRootDirectory, 'sources' )

const packageRootDirectory                = iteePackageRootDirectory.includes( 'node_modules' ) ? join( iteePackageRootDirectory, '../../../' ) : iteePackageRootDirectory
const packageTasksDirectory               = join( packageRootDirectory, '.tasks' )
const packageTasksConfigurationsDirectory = join( packageTasksDirectory, 'configs' )
const packageNodeModulesDirectory         = join( packageRootDirectory, 'node_modules' )
const packageBuildsDirectory              = join( packageRootDirectory, 'builds' )
const packageSourcesDirectory             = join( packageRootDirectory, 'sources' )
const packageSourcesBackendDirectory      = join( packageSourcesDirectory, 'backend' )
const packageSourcesCommonDirectory       = join( packageSourcesDirectory, 'common' )
const packageSourcesFrontendDirectory     = join( packageSourcesDirectory, 'frontend' )
const packageTestsDirectory               = join( packageRootDirectory, 'tests' )
const packageTestsBenchmarksDirectory     = join( packageTestsDirectory, 'benchmarks' )
const packageTestsBundlesDirectory        = join( packageTestsDirectory, 'bundles' )
const packageTestsUnitsDirectory          = join( packageTestsDirectory, 'units' )
const packageDocsDirectory                = join( packageRootDirectory, 'docs' )
const packageTutorialsDirectory           = join( packageRootDirectory, 'tutorials' )
const packageJsonPath                     = join( packageRootDirectory, 'package.json' )

///

const packageJson        = getJsonFrom( packageJsonPath )
const packageName        = packageJson.name
const packageVersion     = packageJson.version
const packageDescription = packageJson.description
const packageAuthor      = packageJson.author
const packageLicense     = packageJson.license

function getPrettyPackageName( separator = ' ' ) {

    let prettyPackageName = ''

    const nameSplits = packageName.split( '-' )
    for ( const nameSplit of nameSplits ) {
        prettyPackageName += nameSplit.charAt( 0 ).toUpperCase() + nameSplit.slice( 1 ) + separator
    }
    prettyPackageName = prettyPackageName.slice( 0, -1 )

    return prettyPackageName

}

function getPrettyPackageVersion() {

    return 'v' + packageVersion

}

function getPrettyNodeVersion() {

    let nodeVersion = 'vX.x.ₓ'

    try {
        nodeVersion = childProcess.execFileSync( 'node', [ '--version' ] )
                                  .toString()
                                  .replace( /(\r\n|\n|\r)/gm, '' )
    } catch ( e ) {
        log( red( e ) )

        if ( e.message.includes( 'ENOENT' ) ) {
            nodeVersion += yellow( ' Not seems to be accessible from the path environment.' )
        }
    }

    return ' node: ' + nodeVersion

}

function getPrettyNpmVersion() {

    let npmVersion = 'X.x.ₓ'

    try {
        npmVersion = childProcess.execFileSync( 'npm', [ '--version' ] )
                                 .toString()
                                 .replace( /(\r\n|\n|\r)/gm, '' )
    } catch ( e ) {
        log( red( e ) )

        if ( e.message.includes( 'ENOENT' ) ) {
            npmVersion += yellow( ' Not seems to be accessible from the path environment.' )
        }
    }

    return ' npm:  v' + npmVersion

}

/// File system Management

function createDirectoryIfNotExist( directoryPath ) {

    if ( !existsSync( directoryPath ) ) {
        log( 'Creating', green( directoryPath ) )
        mkdirSync( directoryPath, { recursive: true } )
    }

}

function getJsonFrom( path ) {

    const buffer = readFileSync( path )
    return JSON.parse( buffer.toString() )

}

function createFile( filePath, fileContent ) {

    log( 'Creating', green( filePath ) )
    writeFileSync( filePath, fileContent )

}

function getFilesFrom( globPattern, filter = ( any ) => true ) {

    return glob.sync( globPattern )
               .map( filePath => normalize( filePath ) )
               .filter( filter )

}

/// Task Management

async function getTasksFrom( taskFiles = [] ) {

    const tasks = []
    for ( const taskFile of taskFiles ) {
        const relativeTaskFile = relative( packageRootDirectory, taskFile )

        try {

            const module = await import(taskFile)

            const exportStrings = []
            for ( const moduleKey in module ) {
                const task = module[ moduleKey ]
                tasks.push( task )

                const name         = task.name ?? null
                const displayName  = task.displayName ?? null
                const fullName     = ( moduleKey !== name ) ? `${ blue( moduleKey ) }( ${ magenta( name ) } )` : `${ blue( name ) }`
                const exportAs     = ( displayName ) ? ` as ${ cyan( displayName ) }` : ''
                const exportString = fullName + exportAs
                exportStrings.push( exportString )
            }

            //log( 'Process ', green( relativeTaskFile ), `with task${ ( exportStrings.length > 1 ) ? 's' : '' }`, exportStrings.join( ', ' ) )

        } catch ( error ) {

            log( 'Error   ', red( relativeTaskFile ), error.message )

        }

    }

    return tasks

}

async function serializeTasksFrom( taskFiles = [] ) {

    const tasks = await getTasksFrom( taskFiles )
    return series( ...tasks )

}

async function parallelizeTasksFrom( taskFiles = [] ) {

    const tasks = await getTasksFrom( taskFiles )
    return parallel( ...tasks )

}

/// Task configuration management

function getTaskConfigurationPathFor( filename ) {

    // Get relative path of the task between internal or user defined
    let relativeTaskPath = filename.includes( iteePackageSourcesDirectory )
                           ? relative( iteePackageSourcesDirectory, filename )
                           : relative( packageTasksDirectory, filename )

    // Generate all possible config file path depending on file extension and default or user defined
    const terminalExtension = extname( relativeTaskPath )
    const searchValue       = relativeTaskPath.includes( '.task.' ) ? `.task${ terminalExtension }` : terminalExtension
    const replaceValues     = [
        '.conf.json',
        '.conf.js',
        '.conf.cjs',
        '.conf.mjs',
    ]

    const packageConfigurationPaths = []
    const defaultConfigurationPaths = []

    for ( const replaceValue of replaceValues ) {
        const configurationLocation    = relativeTaskPath.replace( searchValue, replaceValue )
        const packageConfigurationPath = join( packageTasksConfigurationsDirectory, configurationLocation )
        const defaultConfigurationPath = join( iteePackageConfigurationsDirectory, configurationLocation )

        packageConfigurationPaths.push( packageConfigurationPath )
        defaultConfigurationPaths.push( defaultConfigurationPath )
    }

    // Take care of the configuration search order (package first then default !)
    const configurationPaths = [ ...packageConfigurationPaths, ...defaultConfigurationPaths ]
    let configurationPath    = undefined

    // Looking for existing configuration file
    for ( const packageConfigurationPath of configurationPaths ) {

        if ( existsSync( packageConfigurationPath ) ) {
            configurationPath = packageConfigurationPath
            break
        }

    }

    // Else throw an error
    if ( !configurationPath ) {
        throw new Error( `Unable to find configuration in package configuration paths ${ configurationPaths.join( ', ' ) }.` )
    }

    return configurationPath

}

async function getTaskConfigurationFor( filename ) {

    const configurationFilePath = getTaskConfigurationPathFor( filename )

    log( `Loading configuration from ${ cyan( configurationFilePath ) }` )

    let configuration = null

    try {

        if ( extname( configurationFilePath ) === '.json' ) {

            configuration = getJsonFrom( configurationFilePath )

        } else {

            const moduleData = await import( configurationFilePath )
            configuration    = moduleData.default

        }

    } catch ( e ) {

        log( red( e ) )

    }

    return configuration

}

/// Build management

function getPrettyFormatForBanner( format ) {

    let prettyFormat = ''

    switch ( format ) {

        case 'cjs':
            prettyFormat = 'CommonJs'
            break

        case 'esm':
            prettyFormat = 'EsModule'
            break

        case 'iife':
            prettyFormat = 'Standalone'
            break

        case 'umd':
            prettyFormat = 'Universal'
            break

        default:
            throw new RangeError( `Invalid switch parameter: ${ format }` )

    }

    return prettyFormat

}

function convertBannerIntoComment( banner ) {

    let bannerCommented = '/**\n'
    bannerCommented += ' * '
    bannerCommented += banner.replaceAll( '\n', '\n * ' )
    bannerCommented += '\n'
    bannerCommented += ` * @desc    ${ packageDescription }\n`
    bannerCommented += ' * @author  [Tristan Valcke]{@link https://github.com/Itee}\n'
    bannerCommented += ' * @license [BSD-3-Clause]{@link https://opensource.org/licenses/BSD-3-Clause}\n'
    bannerCommented += ' * \n'
    bannerCommented += ' */'

    return bannerCommented

}

function computeBannerFor( format ) {

    const packageName    = getPrettyPackageName( '.' )
    const packageVersion = getPrettyPackageVersion()
    const prettyFormat   = getPrettyFormatForBanner( format )

    const figText = figlet.textSync(
        `${ packageName } ${ packageVersion } - ${ prettyFormat }`,
        {
            font:             'Tmplr',
            horizontalLayout: 'default',
            verticalLayout:   'default',
            whitespaceBreak:  true,
        }
    )

    return convertBannerIntoComment( figText )

}

function computeIntroFor( requestPackages ) {

    return ''

}

function getOutputFileExtensionBasedOnFileFormat( format ) {

    let extension

    if ( format === 'cjs' ) {
        extension = 'cjs'
    } else if ( format === 'esm' ) {
        extension = 'mjs'
    } else {
        extension = 'js'
    }

    return extension

}

/**
 * Will create an appropriate configuration object for rollup, related to the given arguments.
 *
 * @generator
 * @param options
 * @return {Array.&lt;json>} An array of rollup configuration
 */
function createRollupConfigs( options = undefined ) {

    const _options = options ? options : {
        input:     join( packageSourcesDirectory, `${ packageName }.js` ),
        output:    packageBuildsDirectory,
        formats:   [ 'esm', 'cjs', 'iife' ],
        envs:      [ 'dev', 'prod' ],
        treeshake: true
    }

    const {
              input,
              output,
              formats,
              envs,
              treeshake
          }        = _options
    const name     = getPrettyPackageName( '.' )
    const fileName = basename( input, '.js' )

    const configs = []

    for ( let formatIndex = 0, numberOfFormats = formats.length ; formatIndex &lt; numberOfFormats ; ++formatIndex ) {

        for ( let envIndex = 0, numberOfEnvs = envs.length ; envIndex &lt; numberOfEnvs ; envIndex++ ) {

            const env        = envs[ envIndex ]
            const isProd     = ( env.includes( 'prod' ) )
            const format     = formats[ formatIndex ]
            const extension  = getOutputFileExtensionBasedOnFileFormat( format )
            const outputPath = ( isProd ) ? join( output, `${ fileName }.min.${ extension }` ) : join( output, `${ fileName }.${ extension }` )

            configs.push( {
                input:     input,
                external:  ( format === 'cjs' ) ? [
                    'fs'
                ] : [],
                plugins:   [
                    replace( {
                        defines: {
                            IS_REMOVE_ON_BUILD:  false,
                            IS_BACKEND_SPECIFIC: ( format === 'cjs' )
                        }
                    } ),
                    commonjs( {
                        include: 'node_modules/**'
                    } ),
                    nodeResolve( {
                        preferBuiltins: true
                    } ),
                    isProd &amp;&amp; terser()
                ],
                onwarn:    ( {
                    loc,
                    frame,
                    message
                } ) => {

                    // Ignore some errors
                    if ( message.includes( 'Circular dependency' ) ) { return }
                    if ( message.includes( 'plugin uglify is deprecated' ) ) { return }

                    if ( loc ) {
                        process.stderr.write( `/!\\ ${ loc.file } (${ loc.line }:${ loc.column }) ${ frame } ${ message }\n` )
                    } else {
                        process.stderr.write( `/!\\ ${ message }\n` )
                    }

                },
                treeshake: treeshake,
                output:    {
                    // core options
                    file:    outputPath,
                    format:  format,
                    name:    name,
                    globals: {},

                    // advanced options
                    paths:     {},
                    banner:    ( isProd ) ? '' : computeBannerFor( format ),
                    footer:    '',
                    intro:     ( !isProd &amp;&amp; format === 'iife' ) ? computeIntroFor() : '',
                    outro:     '',
                    sourcemap: !isProd,
                    interop:   'auto',

                    // danger zone
                    exports: 'auto',
                    amd:     {},
                    indent:  '\t',
                    strict:  true
                }
            } )

        }

    }

    return configs

}

/// Log Management

function logLoadingTask( filename ) {

    if ( !isDebugging ) {
        return
    }

    const taskPath = relative( packageRootDirectory, filename )
    const taskName = basename( filename, '.task.mjs' )

    log( `Loading  ${ green( taskPath ) } with task ${ blue( taskName ) }` )

}

///

function IndenterFactory( indentationChar = '\t', indentationLevel = 5 ) {

    const indentationLevels = {}
    let currentProperty     = 'I_'
    for ( let currentIndentationLevel = 1 ; currentIndentationLevel &lt;= indentationLevel ; currentIndentationLevel++ ) {
        indentationLevels[ currentProperty ] = indentationChar.repeat( currentIndentationLevel )
        currentProperty += '_'
    }

    return {
        I: new Indenter( indentationChar ),
        ...indentationLevels
    }

}

class Indenter {

    constructor( indentationChar = '\t' ) {

        this.indentationChar         = indentationChar
        this.currentIndentationLevel = 0

    }

    _( indentationLevel = null ) {
        return this.indentationChar.repeat( indentationLevel ?? this.currentIndentationLevel )
    }

    deeper( level = 1 ) {
        this.currentIndentationLevel += level
    }

    shallower( level = 1 ) {
        this.currentIndentationLevel -= level
    }

}

///

export {
    iteePackageRootDirectory,
    iteePackageJsonPath,
    iteePackageConfigurationsDirectory,
    iteePackageNodeModulesDirectory,
    iteePackageSourcesDirectory,

    packageRootDirectory,
    packageTasksDirectory,
    packageTasksConfigurationsDirectory,
    packageNodeModulesDirectory,
    packageBuildsDirectory,
    packageSourcesDirectory,
    packageSourcesBackendDirectory,
    packageSourcesCommonDirectory,
    packageSourcesFrontendDirectory,
    packageTestsDirectory,
    packageTestsBenchmarksDirectory,
    packageTestsBundlesDirectory,
    packageTestsUnitsDirectory,
    packageDocsDirectory,
    packageTutorialsDirectory,
    packageJsonPath,

    packageJson,
    packageName,
    packageVersion,
    packageDescription,
    packageAuthor,
    packageLicense,
    getPrettyPackageName,
    getPrettyPackageVersion,
    getPrettyNodeVersion,
    getPrettyNpmVersion,


    createDirectoryIfNotExist,
    getJsonFrom,
    createFile,
    getFilesFrom,

    getTasksFrom,
    serializeTasksFrom,
    parallelizeTasksFrom,

    getTaskConfigurationPathFor,
    getTaskConfigurationFor,

    getPrettyFormatForBanner,
    convertBannerIntoComment,
    computeBannerFor,
    computeIntroFor,
    createRollupConfigs,

    logLoadingTask,

    IndenterFactory as Indenter
}</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


	<span class="copyright">
	Copyright 2015-Present <a href="https://github.com/Itee">Itee</a> (Tristan Valcke)
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a>
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
